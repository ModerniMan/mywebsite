<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>××—×•×œ×œ ×ª××•× ×•×ª ×™×“×™×“×™×</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Palette */
            --c-blue-dark: #2c6da6;
            --c-blue-light: #e3f2fd;
            --c-gold: #ffd700;
            --c-orange: #fbc02d;
            --c-red: #ef5350;
            --c-cyan: #80deea;

            --c-text-main: #37474f;
            --c-text-muted: #78909c;
            --c-warning: #d32f2f;

            /* Graph Colors */
            --g-hanaa: #29b6f6;
            --g-pancer: #ffa726;
            --g-locked: #ff7043;
            --ring-blue: #42a5f5;
            --ring-green: #66bb6a;
            --ring-orange: #ffa726;
        }

        :root {
            --bg-color: #f0f2f5;
            --panel-bg: rgba(255, 255, 255, 0.65);
            --text-main: #37474f;
            --text-detail: #546e7a;
            --border-color: rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --panel-bg: rgba(40, 40, 40, 0.65);
            --text-main: #e0e0e0;
            --text-detail: #b0bec5;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            direction: rtl;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        /* --- Sidebar & Controls --- */
        .sidebar {
            width: 420px;
            /* Fixed wider width */
            display: flex;
            flex-direction: column;
            background: #fff;
            height: 100vh;
            overflow-y: auto;
            border-left: 1px solid #ddd;
            z-index: 100;
            box-sizing: border-box;
        }

        .control-panel {
            width: 100%;
            min-height: 100%;
            /* Glassmorphism Effect */
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--glass-shadow);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Removed internal overflow to let sidebar handle scroll */
            z-index: 100;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-sizing: border-box;
        }

        .control-panel h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 6px;
            font-family: inherit;
            font-weight: 600;
            font-size: 14px;
            flex: 1;
            text-align: center;
            transition: 0.2s;
        }

        .tab-btn:hover {
            background: #e3f2fd;
        }

        .tab-btn.active {
            background: var(--c-blue-dark);
            color: #fff;
            border-color: var(--c-blue-dark);
        }

        .controls-section {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: #fafafa;
        }

        .section-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--c-blue-dark);
            margin-bottom: 10px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 600;
            color: #546e7a;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Assistant', sans-serif;
            background: #fff;
            transition: border 0.2s;
            box-sizing: border-box;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            border-color: var(--c-blue-dark);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .input-row .input-group {
            flex: 1;
        }

        .smart-paste-area {
            font-family: monospace;
            font-size: 12px;
            white-space: pre;
            overflow-x: auto;
        }

        .hidden {
            display: none;
        }

        .download-btn {
            background: linear-gradient(135deg, #26a69a, #00897b);
            color: #fff;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(38, 166, 154, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            margin-top: 10px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(38, 166, 154, 0.5);
        }

        /* Share Button */
        .share-btn {
            background: linear-gradient(135deg, #42a5f5, #1976d2);
            color: #fff;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(66, 165, 245, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 165, 245, 0.5);
        }

        /* --- Header Section (Shared) --- */
        .header-section {
            background: var(--c-blue-dark);
            color: #fff;
            padding: 30px 0 20px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: 8px 8px 0 0;
        }

        .header-section h1 {
            font-size: 38px;
            font-weight: 800;
            margin: 0;
            line-height: 1;
        }

        .header-section span {
            font-size: 18px;
            margin-top: 5px;
            opacity: 0.9;
        }

        .card-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- Statistics Styles --- */
        .stats-row {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            background: #fcfcfc;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 6px solid #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: 900;
            color: #455a64;
            background: #fff;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 800;
            color: #546e7a;
            margin-top: 5px;
        }

        .card-heading {
            font-size: 18px;
            font-weight: 800;
            color: var(--c-blue-dark);
            border-right: 4px solid var(--c-orange);
            padding-right: 10px;
            margin-bottom: 10px;
        }

        /* --- Graph Styles --- */
        .graph-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 12px;
            height: 150px;
            margin-top: 10px;
        }

        .graph-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
            height: 100%;
            justify-content: flex-end;
        }

        .g-val {
            font-size: 12px;
            font-weight: 800;
            color: #455a64;
        }

        .g-track {
            width: 12px;
            height: 100%;
            background: #eceff1;
            border-radius: 10px;
            display: flex;
            align-items: flex-end;
            position: relative;
        }

        .g-bar {
            width: 100%;
            border-radius: 10px;
            min-height: 4px;
        }

        .g-label {
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            color: #546e7a;
            margin-top: 4px;
            line-height: 1.1;
        }

        /* Bar Colors */
        .bar-hanaa {
            background: var(--g-hanaa);
        }

        .bar-pancer {
            background: var(--g-pancer);
        }

        .bar-locked {
            background: var(--g-locked);
        }

        .bar-fuel {
            background: #7e57c2;
        }

        .bar-door {
            background: #ab47bc;
        }

        .bar-transport {
            background: #26a69a;
        }

        .bar-war {
            background: #5c6bc0;
        }

        .bar-other {
            background: #8d6e63;
        }

        /* --- Podium Styles --- */
        .excellence-container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-end;
            gap: 40px;
            margin-top: 15px;
            width: 100%;
        }

        .podium-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .podium-title {
            font-size: 16px;
            font-weight: 800;
            color: #546e7a;
            margin-bottom: 5px;
            text-align: center;
        }

        .podium-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 10px;
        }

        .podium-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 70px;
            position: relative;
            justify-content: flex-end;
            height: 100%;
        }

        .p-avatar {
            font-size: 12px;
            font-weight: 800;
            color: #263238;
            text-align: center;
            margin-bottom: 25px;
            min-height: 30px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            line-height: 1.1;
        }

        .p-block {
            width: 100%;
            display: flex;
            justify-content: center;
            padding-top: 5px;
            border-radius: 6px 6px 0 0;
            position: relative;
        }

        .rank-num {
            font-size: 22px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 8px;
        }

        .medal-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #ffd700;
            border: 2px solid #fff;
            position: absolute;
            top: -14px;
            z-index: 5;
        }

        .place-2 .p-block {
            height: 65px;
            background: linear-gradient(135deg, #64b5f6, #42a5f5);
        }

        .place-1 .p-block {
            height: 90px;
            background: linear-gradient(135deg, #81c784, #66bb6a);
            transform: scale(1.05);
            transform-origin: bottom;
        }

        .place-3 .p-block {
            height: 50px;
            background: linear-gradient(135deg, #7986cb, #5c6bc0);
        }

        .badge-wrapper {
            display: flex;
            justify-content: center;
        }

        .certificate-box {
            background: linear-gradient(135deg, #fff, #fffde7);
            border: 1px solid #ffd54f;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            transform: rotate(-2deg);
            width: 120px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .c-star {
            font-size: 30px;
            margin-bottom: 0;
            line-height: 1;
        }

        .c-title {
            font-size: 10px;
            font-weight: 800;
            color: #546e7a;
            text-transform: uppercase;
        }

        .c-name {
            font-size: 14px;
            font-weight: 900;
            color: #e65100;
            margin: 2px 0;
        }

        .c-sub {
            font-size: 10px;
            color: #90a4ae;
            font-weight: 600;
            line-height: 1.1;
        }

        .card-footer {
            text-align: center;
            font-size: 12px;
            color: #90a4ae;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* --- Welcome Card Styles --- */
        #card-welcome {
            width: auto;
            max-width: 100%;
            display: none;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            background: transparent;
            box-shadow: none;
        }

        .welcome-card-base {
            width: 320px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
        }

        .w-card-header {
            padding: 20px;
            text-align: center;
            color: #fff;
            position: relative;
        }

        .header-blue {
            background: linear-gradient(135deg, #42a5f5, #1976d2);
        }

        .header-red {
            background: linear-gradient(135deg, #ef5350, #c62828);
        }

        .w-card-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 800;
        }

        .w-card-header h2 {
            margin: 5px 0 0 0;
            font-size: 16px;
            font-weight: 600;
            opacity: 0.9;
        }

        .alert-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 5px;
        }

        .welcome-content {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .names-grid {
            display: flex;
        }

        /* --- Certificate Base Styles (Shared/Base) --- */
        .cert-mask {
            position: absolute;
            top: 52%;
            /* Slightly lower than center usually fits better */
            left: 50%;
            transform: translate(-50%, -50%);
            /* This will be overridden by inline styles from JS */
            width: 80%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            z-index: 5;
        }

        .cert-to {
            font-size: 32px;
            font-weight: 700;
            color: #1565c0;
            margin-bottom: 5px;
        }

        .cert-name {
            font-size: 60px;
            font-weight: 900;
            color: #0d47a1;
            line-height: 1.1;
            margin: 5px 0 15px 0;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .cert-reason {
            font-size: 28px;
            font-weight: 600;
            color: #455a64;
            margin-bottom: 25px;
        }

        .cert-blessing {
            font-size: 24px;
            font-weight: 600;
            color: #1e88e5;
            background: #fff;
            padding: 8px 25px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            white-space: nowrap;
        }

        .cert-footer-text {
            font-size: 36px;
            font-weight: 900;
            color: #1565c0;
            margin-top: 30px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* --- Certificate Card Styles --- */
        #card-cert {
            background-image: url('cert_bg.png');
            background-size: cover;
            background-position: center;
            overflow: hidden;
            width: 563px;
            height: 846px;
            margin: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #card-cert .cert-name {
            font-size: 65px !important;
            color: #ffffff !important;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
            margin-top: 5px;
        }

        #card-cert .cert-to {
            font-size: 28px;
            color: #e3f2fd !important;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
        }

        #card-cert .cert-reason {
            color: #bbdefb !important;
            font-size: 24px;
            font-weight: 400 !important;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        #card-cert .cert-blessing {
            color: #0d47a1 !important;
            text-shadow: none !important;
            font-weight: 700;
            font-size: 20px;
            padding: 8px 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 12px;
        }

        #card-cert .cert-footer-text {
            color: #ffffff !important;
            font-size: 32px;
            margin-top: 15px;
            position: relative;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-weight: 800;
        }

        #card-cert .cert-side-credit {
            position: absolute;
            left: -105px;
            bottom: 200px;
            transform: rotate(-90deg);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Assistant', sans-serif;
            z-index: 10;
        }

        #card-cert .credit-text {
            color: #ffffff;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 1px;
        }

        #card-cert .credit-pill {
            background-color: #ffffff;
            color: #8cbd4d;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
        }

        /* --- Birthday Card Styles --- */
        #card-birthday {
            width: 563px;
            height: 846px;
            margin: auto;
            position: relative;
            overflow: hidden;
            /* Default to Male */
            background-image: url('birthday_bg.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            font-family: 'Assistant', sans-serif;
        }

        #card-birthday .cert-mask {
            position: absolute;
            top: 56%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0px;
            text-align: center;
        }

        #card-birthday .cert-to,
        #card-birthday .cert-reason,
        #card-birthday .cert-blessing,
        #card-birthday .cert-footer-text {
            background-color: transparent;
            padding: 2px 5px;
            border-radius: 0;
            box-shadow: none;
            width: fit-content;
            max-width: 95%;
            margin-left: auto;
            margin-right: auto;
            color: #000000;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            font-weight: 600;
            line-height: 1.2;
        }

        #card-birthday .cert-name {
            position: absolute !important;
            top: 50px;
            /* Positioned perfectly between "×œ××ª× ×“×‘×ª ×”×™×§×¨×”" and "×œ×¨×’×œ ×™×•× ×”×”×•×œ×“×ª" (relative to mask) */
            left: 50%;
            transform: translateX(-50%);
            background-color: transparent;
            font-size: 40px;
            font-weight: 800;
            color: #000000;
            text-shadow: 0 2px 0px rgba(255, 255, 255, 0.5);
            margin: 0;
            line-height: 1;
            width: auto;
            text-align: center;
        }

        #card-birthday .cert-side-credit {
            position: absolute !important;
            left: -105px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Assistant', sans-serif;
            z-index: 10;
        }

        #card-birthday .credit-text {
            color: #4a148c;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: 1px;
        }

        #card-birthday .credit-pill {
            background-color: #4a148c;
            color: #ffffff;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
        }

        #card-birthday .cert-to {
            font-size: 24px;
            font-weight: 600;
            color: #000000;
            text-shadow: none;
            margin-bottom: 5px;
        }

        #card-birthday .cert-reason {
            font-size: 22px;
            color: #000000;
            text-shadow: none;
            margin-bottom: 12px;
            font-weight: 700;
        }

        #card-birthday .cert-blessing {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            background-color: #ffffff;
            padding: 6px 20px;
            border-radius: 50px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            margin: 3px 0;
            transform: none;
            text-shadow: none;
            width: fit-content;
            max-width: 90%;
        }

        #card-birthday .cert-footer-text {
            display: none;
        }

        /* --- Preview Area --- */
        .preview-area {
            flex: 1;
            background-color: #263238;
            background-image:
                linear-gradient(45deg, #37474f 25%, transparent 25%, transparent 75%, #37474f 75%, #37474f),
                linear-gradient(45deg, #37474f 25%, transparent 25%, transparent 75%, #37474f 75%, #37474f);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            overflow-y: auto;
            position: relative;
            transition: background 0.3s;
        }

        #canvas-container {
            margin: auto;
        }

        .main-card {
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.96);
            width: 500px;
            max-width: 95vw;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: visible;
            transition: background 0.3s, color 0.3s;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>
                ××—×•×œ×œ ×™×“×™×“×™×
                <button class="theme-toggle" id="theme-toggle" title="××¦×‘ ×›×”×”/×‘×”×™×¨">ğŸŒ™</button>
            </h2>
            <div class="tabs">
                <button class="tab-btn active" data-tab="tab-stats" onclick="switchTab('stats')">ğŸ“Š ×“×•×— ×©×‘×•×¢×™</button>
                <button class="tab-btn" data-tab="tab-welcome" onclick="switchTab('welcome')">ğŸ‘‹ ×§×‘×œ×ª ×¤× ×™×</button>
                <button class="tab-btn" data-tab="tab-cert" onclick="switchTab('cert')">ğŸ… ×ª×¢×•×“×”</button>
                <button class="tab-btn" data-tab="tab-birthday" onclick="switchTab('birthday')">ğŸ‚ ×™×•× ×”×•×œ×“×ª</button>
            </div>

            <!-- STATS INPUTS -->
            <div id="inputs-stats">
                <div class="section-label">× ×ª×•× ×™× ×›×œ×œ×™×™×</div>
                <div class="input-row">
                    <div class="input-group"><label>×§×¨×™××•×ª ×¡×”"×›</label><input type="number" id="in-total" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>××ª× ×“×‘×™×</label><input type="number" id="in-vols" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>×—×™×¨×•×</label><input type="number" id="in-emer" value=""
                            oninput="renderStats()"></div>
                </div>

                <div class="section-label">×”×ª×¤×œ×’×•×ª ××™×¨×•×¢×™×</div>
                <div class="input-row">
                    <div class="input-group"><label>×”× ×¢×”</label><input type="number" id="in-hanaa" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>×¤× ×¦'×¨</label><input type="number" id="in-pancer" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>×¨×›×‘ × ×¢×•×œ</label><input type="number" id="in-locked" value=""
                            oninput="renderStats()"></div>
                </div>
                <div class="input-row" style="margin-top:10px;">
                    <div class="input-group"><label>×©××Ÿ/××™×/×“×œ×§</label><input type="number" id="in-fuel" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>×“×œ×ª ×˜×¨×•×§×”</label><input type="number" id="in-door" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>×©×™× ×•×¢</label><input type="number" id="in-transport" value=""
                            oninput="renderStats()"></div>
                </div>
                <div class="input-row" style="margin-top:10px;">
                    <div class="input-group"><label>×–××Ÿ ×œ×—×™××”</label><input type="number" id="in-war" value=""
                            oninput="renderStats()"></div>
                    <div class="input-group"><label>××—×¨</label><input type="number" id="in-other" value=""
                            oninput="renderStats()"></div>
                </div>

                <div class="section-label">×¨×©×™××ª ××ª× ×“×‘×™× (×œ×¤×•×“×™×•×)</div>
                <div class="input-group">
                    <textarea id="in-list-stats" class="smart-paste-area" oninput="renderStats()"
                        placeholder="×”×“×‘×§ ×©××•×ª ×•××¡×¤×¨×™×..."></textarea>
                </div>

                <div class="input-group" style="margin-top: 10px;">
                    <label>×‘×—×™×¨×ª ××¦×˜×™×™×Ÿ ×™×“× ×™×ª (×”×§×œ×“ ×©×)</label>
                    <input type="text" id="in-star-select" list="star-options" oninput="renderStats(true)"
                        placeholder="×”×ª×—×œ ×œ×”×§×œ×™×“...">
                    <datalist id="star-options"></datalist>
                </div>
            </div>

            <!-- WELCOME INPUTS -->
            <div id="inputs-welcome" class="hidden">
                <div class="section-label">×©××•×ª ××ª× ×“×‘×™×</div>
                <textarea id="in-w-names" oninput="renderWelcome()" placeholder="×”×›× ×¡ ×©××•×ª (×›×œ ×©× ×‘×©×•×¨×”)"></textarea>
                <div class="section-label">×”×’×“×¨×•×ª ××ª×§×“××•×ª (××•×¤×¦×™×•× ×œ×™)</div>
                <div style="font-size:12px; color:#aaa; margin-bottom:5px;">×œ×—×¥ ×¢×œ ×”×˜×§×¡×˜×™× ×‘×ª×¦×•×’×” ×”××§×“×™××” ×›×“×™ ×œ×¢×¨×•×š ××•×ª×
                    ×™×©×™×¨×•×ª</div>
            </div>

            <!-- CERT INPUTS -->
            <div id="inputs-cert" class="hidden">
                <div class="section-label">×¤×¨×˜×™ ××§×‘×œ ×”×ª×¢×•×“×”</div>
                <div class="input-group" style="margin-bottom:10px;">
                    <label>××™×Ÿ (×œ× ×™×¡×•×— ×”×ª×¢×•×“×”)</label>
                    <select id="in-cert-gender" onchange="renderCert()"
                        style="width:100%; padding:10px; border-radius:6px; border:1px solid #cfd8dc; font-family:inherit; text-align:right;">
                        <option value="male">×–×›×¨ (×œ××ª× ×“×‘ ×”×™×§×¨...)</option>
                        <option value="female">× ×§×‘×” (×œ××ª× ×“×‘×ª ×”×™×§×¨×”...)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>×©× ××œ×</label>
                    <input type="text" id="in-cert-name" oninput="renderCert()" placeholder="×™×©×¨××œ ×™×©×¨××œ×™" dir="rtl">
                </div>
                <div class="section-label">×ª×™×§×•×Ÿ ××™×§×•× (×‘××§×¨×” ×”×¦×•×¨×š)</div>
                <div class="input-row">
                    <div class="input-group"><label>×œ××¢×œ×”/×œ××˜×”</label><input type="number" id="in-cert-y" value="0"
                            oninput="renderCert()"></div>
                    <div class="input-group"><label>×™××™× ×”/×©×××œ×”</label><input type="number" id="in-cert-x" value="0"
                            oninput="renderCert()"></div>
                </div>
            </div>

            <!-- BIRTHDAY INPUTS -->
            <div id="inputs-birthday" class="hidden">
                <div class="section-label">×¤×¨×˜×™ ×™×•× ×”×”×•×œ×“×ª</div>
                <div class="input-group" style="margin-bottom:10px;">
                    <div id="controls-bday" class="controls-section">
                        <h3>×”×’×“×¨×•×ª ×™×•× ×”×•×œ×“×ª</h3>
                        <div class="input-group">
                            <label>××™×Ÿ ×”××ª× ×“×‘/×ª:</label>
                            <div class="radio-group" style="display: flex; gap: 15px; margin-bottom: 5px;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    <input type="radio" name="bday-gender" value="male" checked
                                        onchange="updateBirthday()">
                                    ×‘×Ÿ (×™×¨×•×§)
                                </label>
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    <input type="radio" name="bday-gender" value="female" onchange="updateBirthday()">
                                    ×‘×ª (×•×¨×•×“)
                                </label>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>×©× ×”××ª× ×“×‘/×ª:</label>
                            <input type="text" id="in-bday-name" value="×™×©×¨××œ ×™×©×¨××œ×™" oninput="updateBirthday()">
                        </div>
                        <div class="section-label">×ª×™×§×•×Ÿ ××™×§×•× ××ª×§×“×</div>
                        <div class="input-row">
                            <div class="input-group"><label>×œ××¢×œ×”/×œ××˜×”</label><input type="number" id="in-bday-y"
                                    value="0" oninput="updateBirthday()"></div>
                            <div class="input-group"><label>×™××™× ×”/×©×××œ×”</label><input type="number" id="in-bday-x"
                                    value="0" oninput="updateBirthday()"></div>
                        </div>


                    </div>
                </div>
            </div>

            <div id="btn-stat-down" style="margin-top:auto;">
                <!-- Buttons injected by JS based on tab -->
            </div>

            <div id="btn-group-welcome" class="hidden" style="margin-top:auto;">
                <button class="download-btn" onclick="downloadWelcome('family')"
                    style="margin-bottom:10px; background:linear-gradient(135deg, #42a5f5, #1565c0);">×©××•×¨ ××©×¤×—×ª×™×ª
                    (×›×—×•×œ) ğŸ“¥</button>
                <button class="download-btn" onclick="downloadWelcome('operational')"
                    style="background:linear-gradient(135deg, #ef5350, #c62828);">×©××•×¨ ××‘×¦×¢×™×ª (××“×•×) </button>
            </div>

            <div id="btn-group-birthday" class="hidden" style="margin-top:auto;">
                <button class="download-btn" onclick="downloadBirthday()"
                    style="background:linear-gradient(135deg, #e91e63, #c2185b);">ğŸ’ ×”×•×¨×“ ×›×¨×˜×™×¡ ×™×•× ×”×•×œ×“×ª ğŸ“¥</button>
            </div>

            <div id="btn-group-cert" class="hidden" style="margin-top:auto;">
                <button class="download-btn" onclick="downloadCertificate()"
                    style="background:linear-gradient(135deg, #ff9800, #e65100);">ğŸ† ×”×•×¨×“ ×ª×¢×•×“×ª ×”×•×§×¨×” ğŸ“¥</button>
            </div>

            <div class="actions" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">

                <button class="share-btn" onclick="shareImage()">
                    <span id="share-icon">ğŸ”—</span>
                    <span id="share-text">×©×ª×£ / ×”×¢×ª×§ ×œ×•×•××˜×¡××¤</span>
                </button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div id="canvas-container">
            <!-- Background Map Layer (Shared) -->
            <div class="map-layer"></div>

            <!-- CARD 1: STATS -->
            <div id="card-stats" class="main-card">
                <div class="header-section">
                    <h1 contenteditable="true">×™×“×™×“×™× ×¡× ×™×£ ×§×¨×™×•×ª</h1>
                    <span contenteditable="true">×¡×™×›×•× ×©×‘×•×¢×™ | ××—×•×– ×¦×¤×•×Ÿ</span>
                </div>

                <div class="card-body">
                    <!-- Stats Rows -->
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-circle" style="border-color: var(--ring-blue);">
                                <div id="out-total">0</div>
                            </div>
                            <div class="stat-label">ğŸ“ ×§×¨×™××•×ª ×¡×”"×›</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-circle" style="border-color: var(--ring-green);">
                                <div id="out-vols">0</div>
                            </div>
                            <div class="stat-label">ğŸ§¡ ××ª× ×“×‘×™×</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-circle" style="border-color: var(--ring-orange);">
                                <div id="out-emer">0</div>
                            </div>
                            <div class="stat-label">ğŸš¨ ×§×¨×™××•×ª ×—×™×¨×•×</div>
                        </div>
                    </div>

                    <!-- Graphs -->
                    <div class="card-heading" contenteditable="true">×”×ª×¤×œ×’×•×ª ×¡×•×’×™ ×”×§×¨×™××•×ª</div>
                    <div class="graph-container">
                        <!-- Cols -->
                        <div class="graph-col" id="col-hanaa">
                            <div class="g-val" id="txt-hanaa">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-hanaa" id="bar-hanaa" style="height:0%;"></div>
                            </div>
                            <div class="g-label">âš¡ ×”× ×¢×”</div>
                        </div>
                        <div class="graph-col" id="col-pancer">
                            <div class="g-val" id="txt-pancer">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-pancer" id="bar-pancer" style="height:0%;"></div>
                            </div>
                            <div class="g-label">ğŸ› ×¤× ×¦'×¨</div>
                        </div>
                        <div class="graph-col" id="col-locked">
                            <div class="g-val" id="txt-locked">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-locked" id="bar-locked" style="height:0%;"></div>
                            </div>
                            <div class="g-label">ğŸ” ×¨×›×‘ × ×¢×•×œ</div>
                        </div>
                        <div class="graph-col" id="col-fuel">
                            <div class="g-val" id="txt-fuel">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-fuel" id="bar-fuel" style="height:0%;"></div>
                            </div>
                            <div class="g-label">â›½ ×©××Ÿ/××™×/×“×œ×§</div>
                        </div>
                        <div class="graph-col" id="col-door">
                            <div class="g-val" id="txt-door">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-door" id="bar-door" style="height:0%;"></div>
                            </div>
                            <div class="g-label">ğŸšª ×“×œ×ª ×˜×¨×•×§×”</div>
                        </div>
                        <div class="graph-col" id="col-transport">
                            <div class="g-val" id="txt-transport">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-transport" id="bar-transport" style="height:0%;"></div>
                            </div>
                            <div class="g-label">ğŸ“¦ ×©×™× ×•×¢</div>
                        </div>
                        <div class="graph-col" id="col-war">
                            <div class="g-val" id="txt-war">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-war" id="bar-war" style="height:0%;"></div>
                            </div>
                            <div class="g-label">âš”ï¸ ×–××Ÿ ×œ×—×™××”</div>
                        </div>
                        <div class="graph-col" id="col-other">
                            <div class="g-val" id="txt-other">0</div>
                            <div class="g-track">
                                <div class="g-bar bar-other" id="bar-other" style="height:0%;"></div>
                            </div>
                            <div class="g-label">ğŸ¤·â€â™‚ï¸ ××—×¨</div>
                        </div>
                    </div>

                    <!-- Podium -->
                    <div class="card-heading" style="margin-top: 20px;" contenteditable="true">×¤×™×¨×•×˜ ××™×¨×•×¢×™× ×•×”×¦×˜×™×™× ×•×ª
                    </div>
                    <div id="podium-area">
                        <!-- JS Injected -->
                    </div>

                    <div class="card-footer">×›×•× × ×™ ×”×§×¨×™×•×ª - ×’××•×•×” ×™×©×¨××œ×™×ª!</div>
                </div>
            </div>

            <!-- CARD 2: WELCOME -->
            <div id="card-welcome" class="cards-wrapper" style="display:none;">
                <!-- 1. Family Card (Blue) -->
                <div id="card-welcome-family" class="welcome-card-base card-blue">
                    <div class="w-card-header header-blue">
                        <h1 contenteditable="true">×‘×¨×•×›×™× ×”×‘××™×!</h1>
                        <h2 contenteditable="true">×œ×¤×•×¨×•× ×”×¡× ×™×£ - ××œ×•×¤×™ ×”×§×¨×™×•×ª</h2>
                    </div>
                    <div class="welcome-content">
                        <div class="names-grid" id="w-list-family">
                            <!-- JS Injected -->
                        </div>
                        <div class="footer-msg footer-blue" contenteditable="true">
                            ×œ×©×ª×£, ×œ×”×ª×™×™×¢×¥, ×œ×¦×—×•×§ ×•×œ×”×™×•×ª ×××•×—×“×™× â¤ï¸<br>
                            ×¡× ×™×£ ×§×¨×™×•×ª - ××©×¤×—×” ××—×ª ×’×“×•×œ×”!
                        </div>
                    </div>
                </div>

                <!-- 2. Operational Card (Red) -->
                <div id="card-welcome-operational" class="welcome-card-base card-red">
                    <div class="w-card-header header-red">
                        <div class="alert-badge">âš ï¸ ×§×‘×•×¦×” ×–×• ×”×™× ××‘×¦×¢×™×ª ×‘×œ×‘×“!</div>
                        <h1 contenteditable="true">×‘×¨×•×›×™× ×”×‘××™×!</h1>
                        <h2 contenteditable="true">×œ×§×‘×•×¦×” ×”××‘×¦×¢×™×ª ×©×œ ××œ×•×¤×™ ×”×§×¨×™×•×ª</h2>
                    </div>
                    <div class="welcome-content">
                        <div class="names-grid" id="w-list-operational">
                            <!-- JS Injected -->
                        </div>
                        <div class="footer-msg footer-red" contenteditable="true">
                            ×”×§×‘×•×¦×” ×¤×¢×™×œ×” 6 ×™××™× ×‘×©×‘×•×¢<br>
                            ××™× ×” ×¤×¢×™×œ×” ×‘×©×‘×ª ×•××•×¢×“×™ ×™×©×¨××œ â›”<br>
                            ××™×Ÿ ×œ×”×’×™×‘ ×œ×”×•×“×¢×•×ª ×‘×§×‘×•×¦×” ×–×•
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 3: CERTIFICATE -->
            <div id="card-cert" class="main-card" style="display:none;">
                <div class="cert-mask" id="cert-mask">
                    <div class="cert-to" id="out-cert-to">×œ××ª× ×“×‘ ×”×™×§×¨</div>
                    <div class="cert-name" id="out-cert-name">×™×©×¨××œ ×™×©×¨××œ×™</div>
                    <div class="cert-reason">×œ×¨×’×œ ×§×‘×œ×ª ×”×”×¦×˜×™×™× ×•×ª</div>
                    <div class="cert-blessing">×–×” ××’×™×¢ ×œ×š ×‘×–×›×•×ª ×”×—×¡×“ ×•×”×¢×©×™×™×”</div>
                    <div class="cert-blessing">×©×ª××©×™×š ×œ×”×™×•×ª ×”×¤× ×™× ×”×™×¤×•×ª ×©×œ ×™×©×¨××œ</div>
                    <div class="cert-footer-text">×›×” ×œ×—×™!</div>
                    <div class="cert-side-credit">
                        <span class="credit-text">××’×£ ××“×™×”</span>
                        <span class="credit-pill">×™×“×™×“×™×</span>
                    </div>
                </div>
            </div>

            <!-- CARD 4: BIRTHDAY -->
            <div id="card-birthday" style="display:none;">
                <div class="cert-mask" id="bday-mask">
                    <!-- Only the name is dynamically added - all other text is embedded in the background image -->
                    <div class="cert-name" id="out-bday-name" contenteditable="true">×™×©×¨××œ ×™×©×¨××œ×™</div>
                    <div class="cert-side-credit">
                        <span class="credit-text">××’×£ ××“×™×”</span>
                        <span class="credit-pill">×™×“×™×“×™×</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'stats';

        // 1. Dark Mode Logic
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        if (localStorage.getItem('darkMode') === 'true') {
            body.classList.add('dark-mode');
            themeToggle.textContent = 'â˜€ï¸';
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('darkMode', isDark);
        });

        // 2. Local History
        const inputsToSave = ['in-w-names', 'in-cert-to', 'in-cert-name', 'in-cert-reason', 'in-bday-name'];
        inputsToSave.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                const saved = localStorage.getItem('autosave_' + id);
                if (saved) {
                    input.value = saved;
                }
                input.addEventListener('input', (e) => {
                    localStorage.setItem('autosave_' + id, e.target.value);
                });
            }
        });

        // 3. Smart Share Logic
        async function shareImage() {
            const activeTabId = document.querySelector('.tab-btn.active').dataset.tab;
            let targetId;
            if (activeTabId === 'tab-stats') targetId = 'card-stats';
            else if (activeTabId === 'tab-welcome') targetId = 'card-welcome';
            else if (activeTabId === 'tab-cert') targetId = 'card-cert';
            else if (activeTabId === 'tab-birthday') targetId = 'card-birthday';

            const node = document.getElementById(targetId);
            const shareBtnText = document.getElementById('share-text');
            const originalText = shareBtnText.textContent;
            shareBtnText.textContent = '...××›×™×Ÿ ×©×™×ª×•×£';

            try {
                // Use html2canvas consistent with download function
                const canvas = await html2canvas(node, { scale: 2, useCORS: true, backgroundColor: null });

                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        console.error('Canvas to Blob failed');
                        shareBtnText.textContent = '×©×’×™××”';
                        setTimeout(() => { shareBtnText.textContent = originalText; }, 3000);
                        return;
                    }

                    const file = new File([blob], "yedidim_share.png", { type: "image/png" });

                    // Try Native Share
                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: '××—×•×œ×œ ×™×“×™×“×™×',
                                text: '×”× ×” ×”×ª××•× ×” ×©×™×¦×¨×ª×™ ×‘××—×•×œ×œ!'
                            });
                            shareBtnText.textContent = '×©×™×ª×•×£ ×”×¦×œ×™×—!';
                        } catch (shareErr) {
                            console.log('Share cancelled or failed', shareErr);
                            shareBtnText.textContent = '×‘×•×˜×œ/× ×›×©×œ';
                        }
                    } else {
                        // Fallback to Clipboard
                        try {
                            await navigator.clipboard.write([
                                new ClipboardItem({ [blob.type]: blob })
                            ]);
                            alert("×”×ª××•× ×” ×”×•×¢×ª×§×” ×œ×œ×•×—! × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ×‘×•×•××˜×¡××¤ (Ctrl+V)");
                            shareBtnText.textContent = '×”×•×¢×ª×§! ×”×“×‘×§ ×‘×•×•××˜×¡××¤';
                        } catch (clipErr) {
                            console.error('Clipboard failed:', clipErr);
                            alert("×œ× × ×™×ª×Ÿ ×œ×©×ª×£ ×‘×“×¤×“×¤×Ÿ ×–×”. ×× × ×”×©×ª××© ×‘×›×¤×ª×•×¨ ×”×”×•×¨×“×”.");
                            shareBtnText.textContent = '×©×’×™××”';
                        }
                    }
                    setTimeout(() => { shareBtnText.textContent = originalText; }, 3000);
                }, 'image/png');

            } catch (err) {
                console.error('Sharing generation failed:', err);
                alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”×ª××•× ×” ×œ×©×™×ª×•×£.");
                shareBtnText.textContent = '×©×’×™××”';
                setTimeout(() => { shareBtnText.textContent = originalText; }, 3000);
            }
        }

        // 4. Core Logic
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('.tab-btn');
            if (tab === 'stats') btns[0].classList.add('active');
            if (tab === 'welcome') btns[1].classList.add('active');
            if (tab === 'cert') btns[2].classList.add('active');
            if (tab === 'birthday') btns[3].classList.add('active');

            document.getElementById('inputs-stats').style.display = 'none';
            document.getElementById('inputs-welcome').style.display = 'none';
            document.getElementById('inputs-cert').style.display = 'none';
            document.getElementById('inputs-birthday').style.display = 'none';

            document.getElementById('btn-stat-down').style.display = 'none';
            document.getElementById('btn-group-welcome').style.display = 'none';
            document.getElementById('btn-group-birthday').style.display = 'none';
            document.getElementById('btn-group-cert').style.display = 'none';

            document.getElementById('card-stats').style.display = 'none';
            document.getElementById('card-welcome').style.display = 'none';
            document.getElementById('card-cert').style.display = 'none';
            document.getElementById('card-birthday').style.display = 'none';

            const downBtn = document.getElementById('btn-stat-down');

            if (tab === 'stats') {
                document.getElementById('inputs-stats').style.display = 'block';
                downBtn.style.display = 'inline-block';
                downBtn.innerHTML = '<button class="download-btn" onclick="downloadImage()">ğŸ“¥ ×©××•×¨ ×“×•×—</button>';
                document.getElementById('card-stats').style.display = 'flex';
            } else if (tab === 'welcome') {
                document.getElementById('inputs-welcome').style.display = 'block';
                document.getElementById('btn-group-welcome').style.display = 'block';
                document.getElementById('card-welcome').style.display = 'flex';
            } else if (tab === 'cert') {
                document.getElementById('inputs-cert').style.display = 'block';
                document.getElementById('btn-group-cert').style.display = 'block';
                document.getElementById('card-cert').style.display = 'block';
            } else if (tab === 'birthday') {
                document.getElementById('inputs-birthday').style.display = 'block';
                document.getElementById('btn-group-birthday').style.display = 'block';
                document.getElementById('card-birthday').style.display = 'flex';
            }
        }

        function parseNames(text) {
            const lines = text.split('\n');
            let result = [];
            lines.forEach(line => {
                let clean = line.trim();
                let match = clean.match(/^(.*?)[ \-\.]+(\d+)$/);
                if (match) {
                    result.push({ name: match[1].trim(), score: parseInt(match[2]) });
                }
            });
            return result.sort((a, b) => b.score - a.score);
        }

        function updateStarSelect(list) {
            const datalist = document.getElementById('star-options');
            datalist.innerHTML = '';
            list.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p.name;
                datalist.appendChild(opt);
            });
        }

        function renderStats(triggeredBySelect = false) {
            const total = document.getElementById('in-total').value || 0;
            const vols = document.getElementById('in-vols').value || 0;
            const emer = document.getElementById('in-emer').value || 0;
            document.getElementById('out-total').innerText = total;
            document.getElementById('out-vols').innerText = vols;
            document.getElementById('out-emer').innerText = emer;

            const ids = ['pancer', 'hanaa', 'locked', 'fuel', 'door', 'transport', 'war', 'other'];
            const vals = ids.map(id => parseInt(document.getElementById('in-' + id).value) || 0);
            const max = Math.ceil(Math.max(...vals, 1) / 10) * 10;

            ids.forEach((id, idx) => {
                const val = vals[idx];
                const col = document.getElementById('col-' + id);
                const bar = document.getElementById('bar-' + id);
                const txt = col.querySelector('.g-val');
                if (val > 0) {
                    col.style.display = 'flex';
                    bar.style.height = (val / max * 100) + "%";
                    if (txt) txt.innerText = val;
                } else {
                    col.style.display = 'none';
                    bar.style.height = "0%";
                    if (txt) txt.innerText = "0";
                }
            });

            const rawText = document.getElementById('in-list-stats').value;
            let list = parseNames(rawText);
            if (!triggeredBySelect) updateStarSelect(list);

            const overrideName = document.getElementById('in-star-select').value;
            if (overrideName) {
                const idx = list.findIndex(x => x.name === overrideName);
                if (idx > -1) {
                    const person = list.splice(idx, 1)[0];
                    list.unshift(person);
                }
            }
            if (list.length === 0) list = Array(3).fill({ name: '-', score: 0 });
            const top1 = list[0] || { name: '-', score: 0 };
            const top2 = list[1] || { name: '-', score: 0 };
            const top3 = list[2] || { name: '-', score: 0 };

            document.getElementById('podium-area').innerHTML = `
            <div class="excellence-container">
                <div class="podium-section">
                    <div class="podium-title">×”××ª× ×“×‘×™× ×”××•×‘×™×œ×™×</div>
                    <div class="podium-wrapper">
                        <div class="podium-col place-2">
                            <div class="p-avatar" contenteditable="true">${top2.name}<br>${top2.score} ×§×¨×™××•×ª</div>
                            <div class="p-block">
                                <div class="rank-num">2</div>
                                <div class="medal-icon"></div>
                            </div>
                        </div>
                        <div class="podium-col place-1">
                            <div class="p-avatar" contenteditable="true">${top1.name}<br>${top1.score} ×§×¨×™××•×ª</div>
                            <div class="p-block">
                                <div class="rank-num">1</div>
                                <div class="medal-icon"></div>
                            </div>
                        </div>
                        <div class="podium-col place-3">
                            <div class="p-avatar" contenteditable="true">${top3.name}<br>${top3.score} ×§×¨×™××•×ª</div>
                            <div class="p-block">
                                <div class="rank-num">3</div>
                                <div class="medal-icon"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="badge-wrapper">
                    <div class="certificate-box">
                        <div class="c-star">â­</div>
                        <div class="c-title">××¦×˜×™×™×Ÿ ×©×‘×•×¢×™</div>
                        <div class="c-name" contenteditable="true">${top1.name}</div>
                        <div class="c-sub" contenteditable="true">×¢×œ ×ª×¨×•××” ×™×•×¦××ª ×“×•×¤×Ÿ</div>
                    </div>
                </div>
            </div>`;
        }

        function renderWelcome() {
            const namesText = document.getElementById('in-w-names').value;
            const names = namesText.split('\n').filter(n => n.trim() !== '');
            const listFamily = document.getElementById('w-list-family');
            const listOperational = document.getElementById('w-list-operational');
            if (listFamily) listFamily.innerHTML = '';
            if (listOperational) listOperational.innerHTML = '';
            names.forEach(name => {
                let cleanName = name.replace(/\*/g, '').trim();
                let divF = document.createElement('div');
                divF.className = 'name-tag';
                divF.innerHTML = `ğŸ‘‹ ${cleanName}`;
                listFamily.appendChild(divF);
                let divO = document.createElement('div');
                divO.className = 'name-tag';
                divO.innerHTML = `ğŸ›‘ ${cleanName}`;
                listOperational.appendChild(divO);
            });
        }

        function renderCert() {
            const name = document.getElementById('in-cert-name').value || "×™×©×¨××œ ×™×©×¨××œ×™";
            const gender = document.getElementById('in-cert-gender').value;
            const x = document.getElementById('in-cert-x').value;
            const y = document.getElementById('in-cert-y').value;
            const outTo = document.getElementById('out-cert-to');
            document.getElementById('out-cert-name').innerText = name;
            if (gender === 'male') {
                outTo.innerText = "×œ××ª× ×“×‘ ×”×™×§×¨";
            } else {
                outTo.innerText = "×œ××ª× ×“×‘×ª ×”×™×§×¨×”";
            }
            const mask = document.getElementById('cert-mask');
            mask.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
        }

        function updateBirthday() {
            const name = document.getElementById('in-bday-name').value || "×™×©×¨××œ ×™×©×¨××œ×™";
            let gender = 'male';
            const gCheck = document.querySelector('input[name="bday-gender"]:checked');
            if (gCheck) gender = gCheck.value;

            const x = document.getElementById('in-bday-x').value || 0;
            const y = document.getElementById('in-bday-y').value || 0;
            const card = document.getElementById('card-birthday');

            // Only update the name - all other text is embedded in the background image
            document.getElementById('out-bday-name').innerText = name;

            // Switch background image based on gender
            if (gender === 'male') {
                card.style.backgroundImage = "url('birthday_bg.png')";
            } else {
                card.style.backgroundImage = "url('birthday_bg_female.png')";
            }

            const mask = document.getElementById('bday-mask');
            mask.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
        }

        function downloadImage() {
            // Main generic download handler (mostly for Stats tab)
            let targetId = '';
            if (currentTab === 'stats') targetId = 'card-stats';
            else if (currentTab === 'welcome') targetId = 'card-welcome'; // Fallback
            else if (currentTab === 'cert') targetId = 'card-cert';
            else if (currentTab === 'birthday') targetId = 'card-birthday';

            if (targetId) {
                const element = document.getElementById(targetId);
                html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                    let link = document.createElement("a");
                    link.download = "yedidim_" + currentTab + ".png";
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                });
            }
        }

        function downloadWelcome(type) {
            // type is 'family' or 'operational'
            let targetId = (type === 'family') ? 'card-welcome-family' : 'card-welcome-operational';
            const element = document.getElementById(targetId);
            html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                let link = document.createElement("a");
                link.download = `yedidim_welcome_${type}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        function downloadBirthday() {
            const element = document.getElementById('card-birthday');
            html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                const name = document.getElementById('in-bday-name').value || 'birthday';
                let link = document.createElement("a");
                link.download = `yedidim_birthday_${name}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        function downloadCertificate() {
            const element = document.getElementById('card-cert');
            html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                const name = document.getElementById('in-cert-name').value || 'certificate';
                let link = document.createElement("a");
                link.download = `yedidim_certificate_${name}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        // Initialize First Render
        renderStats();
        renderWelcome();
        renderCert();
        updateBirthday();
    </script>
</body>

</html>
